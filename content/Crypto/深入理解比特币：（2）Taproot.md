## 隔离见证回顾

隔离见证于 2017 年作为硬分叉引入，通过隔离签名数据有效地减少了交易数据的大小，通过在一个区块内容纳更多交易来增强交易容量，有效减少由于比特币块大小的限制而导致的网络拥塞。

## Taproot 介绍

Taproot 的背景是提供更好的隐私保护和智能合约功能。涉及 BIP340、BIP341 和 BIP342。

### BIP340 - 椭圆曲线签名算法 (Schnorr 签名)

Schnorr 签名是一种非交互式的数字签名方案，以其创造者 Claus-Peter Schnorr 命名。
#### Schnorr 签名的工作原理

Schnorr 签名基于离散对数问题，这是一种假设，即给定一个大素数 $p$ 和其原根 $g$，以及 $g^x \mod p$，在计算上很难确定 $x$ 的值，除非你知道私钥 $x$。

1. 密钥生成：
	- 选择一个大素数 $p$ 和 $p$ 的原根 $g$。
	- 随机选择一个私钥 $x$，其中 $1 \leq x \leq p-2$。
	- 计算公钥 $X = g^x \mod p$。
1. 签名过程：
	- 选择一个随机数 $k$，其中 $1 \leq k \leq p-2$。
	- 计算点 $R = g^k \mod p$。
	- 计算挑战 $e = H(R || m)$，其中 $m$ 是要签名的消息，$H$ 是一个哈希函数。
	- 计算签名 $s = k + ex \mod p-1$。
1. 验证过程：
	- 使用签名者提供的公钥 $X$、消息 $m$ 和签名 $(R, s)$。
	- 重新计算挑战 $e = H(R || m)$。
	- 验证等式 $g^s \equiv Rg^eX \mod p$ 是否成立。
如果等式成立，则签名有效。
#### Schnorr 签名的优势

1. **简单性**：Schnorr 签名的算法非常简单，易于实现和理解。
2. **安全性**：Schnorr 签名被认为是具有最强的安全属性之一，它对抗各种密码学攻击，如适应性选择消息攻击。
3. **可聚合性**：Schnorr 签名支持签名聚合，多个签名可以合并为一个签名，这对于降低交易费用和提高区块链效率非常重要。
4. **隐私性**：Schnorr 签名可以用于创建不可链接的地址，从而提高用户的隐私。
5. **无状态性**：Schnorr 签名不需要存储以前的签名状态，这使得它可以用于某些优化，如简化支付验证（SPV）。
Schnorr 签名在比特币中的应用是期待已久的，因为它有望解决比特币交易的可扩展性和隐私问题。通过 BIP340 的实施，比特币社区希望能够进一步提高网络的能力，同时保持其去中心化和安全的特性。

### BIP341 - Taproot 软分叉激活

BIP341（Taproot 软分叉激活）是比特币的一个重要升级，它通过软分叉的方式引入了一系列新的功能和改进。Taproot 的主要目标是提高比特币的隐私性、可扩展性和灵活性，同时保持比特币的安全性和去中心化特性。Taproot 的核心贡献是引入了一种新的交易输出类型，称为“Taproot 输出”，以及与之相关的一系列创新。
#### Taproot 的关键特性

1. **Merkle 树分支（Merkelized Abstract Syntax Trees, MAST）**：
   - Taproot 利用 Merkle 树来隐藏交易的复杂性。通过将多个可能的交易输出（分支）编码到一个单一的根哈希中，只有当交易被执行时，实际的分支才会被公开。这提高了交易的隐私性，因为它减少了交易的可见复杂性。
2. **Schnorr 签名**
   - Taproot 引入了 Schnorr 签名，这是一种新的签名方案，它提供了一些关键的优势，包括可聚合性、更好的隐私保护和更简单的安全性证明。
3. **脚本版本的隐藏**
   - 在 Taproot 输出中，脚本的版本号是隐藏的，这意味着外部观察者无法确定一个地址是否使用了新的脚本功能，从而增加了交易的隐私性。
4. **改进的智能合约功能**
   - Taproot 通过新的操作码和结构提供了更强大的智能合约功能，同时保持了交易的简洁性。这为开发更复杂的应用程序提供了可能性，同时减少了链上的数据占用。
5. **软分叉兼容性**
   - Taproot 是通过软分叉实现的，这意味着它向后兼容旧版本的比特币软件。这意味着不需要硬分叉或网络分裂，所有的节点都可以选择升级以支持新的功能。
### BIP342 - Tapscript 脚本语言

关键特性包括：

1. **新的操作码**：Tapscript 引入了一些新的操作码，例如：
   - `OP_CHECKSIGADD`：用于多重签名检查，可以累加公钥的签名验证结果。
   - `OP_SPLIT`：用于创建可分割的输出，允许输出被分成多个部分，每个部分都有自己的锁定脚本。
2. **改进的脚本版本**：Tapscript 使用了一个新的脚本版本，与比特币原有的脚本版本不同。
3. **脚本的限制**：Tapscript 将脚本的尺寸限制为最大 3600 字节

详见：https://en.bitcoin.it/wiki/BIP_0342

闪电网络（Lightning Network）是一种构建在比特币或其他区块链之上的第二层支付协议，旨在解决比特币等第一层区块链在交易速度、成本和可扩展性方面的限制。它允许参与者通过所谓的“支付通道”（payment channels）进行快速、低成本的交易，而不需要直接在区块链上进行每笔交易的记录。
在闪电网络中，当两个人想要进行多次交易时，他们可以在区块链上创建一个多签名的资金托管合约，并预存一定数量的资金。此后，他们可以在不影响区块链主网的情况下，在这个支付通道内无限次地相互转移资金。只有当通道关闭时，最终的余额才会被记录在区块链上，从而大大减少了链上的交易次数和数据量。


## Lightning 网络

在微支付渠道中，使用2-of-2多重签名地址可以在不依赖区块链时间戳系统的情况下，就交易双方之间的余额状态达成一致。

过程如下：
1. **余额状态变更**
   - Alice和Bob可以创建一个未广播的退款交易，以反映新的余额状态（例如0.05 BTC对0.05 BTC变更为0.07 BTC对0.03 BTC）。
2. **避免直接使用区块链**
   - 通过延迟广播交易，双方可以在不需要区块链时间戳的情况下，就新的余额状态达成一致，从而节约网络资源。
3. **解决状态正确性的问题**
   - 为了避免混淆哪个交易状态是正确的（新的支出交易或原始的退款交易），双方只需关注两个状态：当前正确的余额状态和任何旧的已废弃的余额状态。
4. **简化状态管理**
   - 与比特币区块链中所有交易的完全排序不同，微支付渠道的状态管理更为简单，只需追踪两个关键状态，而不是所有交易的历史顺序。

